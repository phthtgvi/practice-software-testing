# T√™n c·ªßa quy tr√¨nh CI/CD
name: Laravel CI/CD with Newman Tests

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code ‚öôÔ∏è
        uses: actions/checkout@v4

      - name: Create Laravel .env file üîß
        env:
          APP_KEY: ${{ secrets.APP_KEY }}
          DB_DATABASE: ${{ secrets.DB_DATABASE }}
          DB_USERNAME: ${{ secrets.DB_USERNAME }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
        run: |
          echo "Creating Laravel .env file from .env.ci template..."
          # L·ªánh envsubst s·∫Ω ƒë·ªçc file .env.ci, t√¨m c√°c bi·∫øn $VAR v√† thay b·∫±ng gi√° tr·ªã t·ª´ secrets
          envsubst < sprint5-with-bugs/API/.env.ci > sprint5-with-bugs/API/.env
          echo ".env file created successfully."

      - name: Start Docker Containers
        run: docker compose up -d

      - name: Wait for Services
        run: sleep 60
        shell: bash

      - name: Setup Application
        run: |
          echo "Installing Composer dependencies..."
          docker compose run --rm composer

          echo "Fixing permissions..."
          docker compose exec -T -u root laravel-api chown -R www-data:www-data /var/www/storage /var/www/bootstrap/cache

          echo "Running database migrations and seeding..."
          docker compose exec -T laravel-api php artisan migrate:fresh --seed --force

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"

      - name: Install Postman CLI
        run: curl -o- "https://dl-cli.pstmn.io/install/linux64.sh" | sh 

      - name: Login to Postman CLI
        run: postman login --with-api-key ${{ secrets.POSTMAN_API_KEY }}

      - name: Run POST /invoices tests
        run: |
            postman collection run 47874393-7a384e4a-fa98-49e1-91f6-6494dd3b4e0c \
            -e 47874393-18898911-5f9b-40a7-810e-013d2595a384 \
            -i 47874393-99fd5861-2531-46f4-909a-d3bc33c40933 \
            -i 47874393-c6785129-b6e7-4ef4-89b9-d4023840645b \
            -d sprint5-with-bugs/API/tests/api/post_invoices.csv\
            --reporters cli,junit,html \
            --reporter-junit-export post-invoices-report.xml \
            --reporter-html-export post-invoices-report.html || true
       
      - name: Run PUT /invoices/invoiceId tests
        run: |
            postman collection run 47874393-7a384e4a-fa98-49e1-91f6-6494dd3b4e0c \
            -e 47874393-18898911-5f9b-40a7-810e-013d2595a384 \
            -i 47874393-99fd5861-2531-46f4-909a-d3bc33c40933 \
            -i 47874393-c6785129-b6e7-4ef4-89b9-d4023840645b \
            -i 47874393-3d6ebf21-5176-4660-9f15-9f4835641596 \
            -d sprint5-with-bugs/API/tests/api/put_invoices.csv \
            --reporters cli,junit,html \
            --reporter-junit-export put-invoices-report.xml \
            --reporter-html-export put-invoices-report.html || true

      - name: Run PUT /invoices/invoiceId/status tests
        run: |
            postman collection run 47874393-7a384e4a-fa98-49e1-91f6-6494dd3b4e0c \
            -e 47874393-18898911-5f9b-40a7-810e-013d2595a384 \
            -i 47874393-99fd5861-2531-46f4-909a-d3bc33c40933 \
            -i 47874393-c6785129-b6e7-4ef4-89b9-d4023840645b \
            -i 47874393-14e3bc46-0c63-463c-83e3-f6c1de72456d \
            -d sprint5-with-bugs/API/tests/api/put_status_invoices.csv \
            --reporters cli,junit,html \
            --reporter-junit-export put-status-invoices-report.xml \
            --reporter-html-export put-status-invoices-report.html || true

      - name: Upload test report 
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: newman-report
          path: |
            *.html
            *.xml
          
      - name: Verdict on test report 
        uses: mikepenz/action-junit-report@v4
        if: always()
        with:
          report_paths: '*.xml'
          fail_on_failure: true

      - name: Cleanup
        if: always()
        run: docker compose down -v